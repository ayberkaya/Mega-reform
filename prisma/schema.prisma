generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── ENUMS ───────────────────────────────────────────

enum UserRole {
  USER
  EXPERT
  ADMIN
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAST_DUE
  TRIALING
  EXPIRED
}

enum SubscriptionPlan {
  FREE
  BASIC
  PREMIUM
  UNLIMITED
}

enum ContentStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum PaymentProvider {
  STRIPE
  IYZICO
}

// ─── USER & AUTH ─────────────────────────────────────

model User {
  id             String    @id @default(cuid())
  name           String?
  email          String    @unique
  emailVerified  DateTime?
  image          String?
  hashedPassword String?
  role           UserRole  @default(USER)
  bio            String?
  phone          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accounts      Account[]
  sessions      Session[]
  subscription  Subscription?
  comments      Comment[]
  favorites     Favorite[]
  enrollments   Enrollment[]
  expertProfile ExpertProfile?
  chatSessions  ChatSession[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ─── EXPERT PROFILE ──────────────────────────────────

model ExpertProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  slug            String   @unique
  title           String
  specialties     String[]
  longBio         String?  @db.Text
  profileImage    String?
  coverImage      String?
  website         String?
  socialLinks     Json?
  yearsExperience Int?
  isVerified      Boolean  @default(false)
  isActive        Boolean  @default(true)
  rating          Float    @default(0)
  reviewCount     Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  articles   Article[]
  courses    Course[]
  comments   Comment[]
  categories ExpertCategory[]

  @@map("expert_profiles")
}

// ─── CATEGORIES ──────────────────────────────────────

model Category {
  id          String  @id @default(cuid())
  name        String  @unique
  slug        String  @unique
  description String?
  icon        String?
  color       String?
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  articles Article[]
  courses  Course[]
  videos   Video[]
  experts  ExpertCategory[]

  @@map("categories")
}

model ExpertCategory {
  expertId   String
  categoryId String

  expert   ExpertProfile @relation(fields: [expertId], references: [id], onDelete: Cascade)
  category Category      @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([expertId, categoryId])
  @@map("expert_categories")
}

// ─── ARTICLES ────────────────────────────────────────

model Article {
  id         String        @id @default(cuid())
  title      String
  slug       String        @unique
  excerpt    String?       @db.Text
  content    String        @db.Text
  coverImage String?
  readTime   Int?
  status     ContentStatus @default(DRAFT)
  isFeatured Boolean       @default(false)
  viewCount  Int           @default(0)
  tags       String[]

  expertId   String
  categoryId String?

  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  expert    ExpertProfile @relation(fields: [expertId], references: [id], onDelete: Cascade)
  category  Category?     @relation(fields: [categoryId], references: [id])
  favorites Favorite[]

  @@index([expertId])
  @@index([categoryId])
  @@index([status, publishedAt])
  @@map("articles")
}

// ─── COURSES ─────────────────────────────────────────

model Course {
  id                   String        @id @default(cuid())
  title                String
  slug                 String        @unique
  description          String?       @db.Text
  coverImage           String?
  previewVideo         String?
  price                Decimal?      @db.Decimal(10, 2)
  currency             String        @default("TRY")
  level                String?
  duration             Int?
  lessonCount          Int           @default(0)
  status               ContentStatus @default(DRAFT)
  isFeatured           Boolean       @default(false)
  isFree               Boolean       @default(false)
  requiresSubscription Boolean       @default(false)
  tags                 String[]
  rating               Float         @default(0)
  enrollmentCount      Int           @default(0)

  expertId   String
  categoryId String?

  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  expert      ExpertProfile @relation(fields: [expertId], references: [id], onDelete: Cascade)
  category    Category?     @relation(fields: [categoryId], references: [id])
  lessons     Lesson[]
  enrollments Enrollment[]
  favorites   Favorite[]

  @@index([expertId])
  @@index([categoryId])
  @@index([status, publishedAt])
  @@map("courses")
}

model Lesson {
  id          String  @id @default(cuid())
  title       String
  slug        String
  description String? @db.Text
  content     String? @db.Text
  videoUrl    String?
  duration    Int?
  sortOrder   Int     @default(0)
  isFree      Boolean @default(false)
  isPublished Boolean @default(false)

  courseId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  course   Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  progress LessonProgress[]

  @@unique([courseId, slug])
  @@index([courseId, sortOrder])
  @@map("lessons")
}

model Enrollment {
  id          String    @id @default(cuid())
  userId      String
  courseId     String
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  course   Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  progress LessonProgress[]

  @@unique([userId, courseId])
  @@map("enrollments")
}

model LessonProgress {
  id             String  @id @default(cuid())
  enrollmentId   String
  lessonId       String
  isCompleted    Boolean @default(false)
  watchedSeconds Int     @default(0)

  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lesson     Lesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, lessonId])
  @@map("lesson_progress")
}

// ─── COMMENTS ────────────────────────────────────────

model Comment {
  id         String  @id @default(cuid())
  content    String  @db.Text
  rating     Int?
  isApproved Boolean @default(false)

  userId   String
  expertId String
  parentId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  expert  ExpertProfile @relation(fields: [expertId], references: [id], onDelete: Cascade)
  parent  Comment?      @relation("CommentReplies", fields: [parentId], references: [id])
  replies Comment[]     @relation("CommentReplies")

  @@index([expertId])
  @@index([userId])
  @@map("comments")
}

// ─── VIDEOS ──────────────────────────────────────────

model Video {
  id            String        @id @default(cuid())
  title         String
  description   String?       @db.Text
  muxAssetId    String?
  muxPlaybackId String?
  thumbnailUrl  String?
  duration      Int?
  status        ContentStatus @default(DRAFT)
  isFeatured    Boolean       @default(false)
  sortOrder     Int           @default(0)

  categoryId String?

  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  category Category? @relation(fields: [categoryId], references: [id])

  @@index([status, sortOrder])
  @@map("videos")
}

// ─── SUBSCRIPTIONS & PAYMENTS ────────────────────────

model Subscription {
  id                 String             @id @default(cuid())
  userId             String             @unique
  plan               SubscriptionPlan   @default(FREE)
  status             SubscriptionStatus @default(ACTIVE)
  provider           PaymentProvider?
  stripeCustomerId   String?            @unique
  stripeSubId        String?            @unique
  iyzicoSubRef       String?            @unique
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelledAt        DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@map("subscriptions")
}

model Payment {
  id                String          @id @default(cuid())
  subscriptionId    String
  amount            Decimal         @db.Decimal(10, 2)
  currency          String          @default("TRY")
  provider          PaymentProvider
  providerPaymentId String?
  status            String

  createdAt DateTime @default(now())

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@map("payments")
}

// ─── FAVORITES ───────────────────────────────────────

model Favorite {
  id        String  @id @default(cuid())
  userId    String
  articleId String?
  courseId  String?

  createdAt DateTime @default(now())

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  article Article? @relation(fields: [articleId], references: [id], onDelete: Cascade)
  course  Course?  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, articleId])
  @@unique([userId, courseId])
  @@map("favorites")
}

// ─── AI CHATBOT SESSIONS ─────────────────────────────

model ChatSession {
  id                   String   @id @default(cuid())
  userId               String?
  sessionToken         String   @unique @default(cuid())
  mood                 String?
  messages             Json
  recommendedExpertIds String[]
  metadata             Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("chat_sessions")
}

// ─── SITE SETTINGS ───────────────────────────────────

model SiteSetting {
  id    String @id @default(cuid())
  key   String @unique
  value Json

  updatedAt DateTime @updatedAt

  @@map("site_settings")
}
